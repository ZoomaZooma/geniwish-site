<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reset Password</title>
  <link rel="stylesheet" href="styles/reset-password.css" />
</head>

<body>
  <!-- Header Section -->
  <header>
    <div class="container">
      <div class="header-content">
        <h1 class="site-heading">Geniwish</h1>
      </div>
    </div>
  </header>

  <!-- Reset Password Section -->
  <section class="reset-password">
    <div class="container">
      <h2>Reset Your Password</h2>
      <p>Please enter your new password below.</p>
      <form id="resetForm">
        <div class="input-group">
          <label for="new-password">New Password:</label>
          <input type="password" id="new-password" name="new-password" placeholder="Enter new password" required 
                 minlength="8" pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$"
                 title="Must contain at least 8 characters, one uppercase, one lowercase, and one number"/>
        </div>
        <div class="input-group">
          <label for="confirm-password">Confirm Password:</label>
          <input type="password" id="confirm-password" name="confirm-password" 
                 placeholder="Confirm new password" required />
        </div>
        <button type="submit" class="btn-submit" id="submitBtn">Reset Password</button>
        <div id="loadingIndicator" style="display: none;">Processing...</div>
      </form>
    </div>
  </section>

  <!-- Footer Section -->
  <footer>
    <p>Â© 2025 Geniwish. All rights reserved.</p>
  </footer>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
    import { SUPABASE_URL, SUPABASE_ANON_KEY } from './supabase-config.js';
  
    document.addEventListener("DOMContentLoaded", async () => {
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      const submitBtn = document.getElementById('submitBtn');
      const loadingIndicator = document.getElementById('loadingIndicator');
  
      const params = new URLSearchParams(window.location.search);
      const token = params.get("code");
      const type = params.get("type");
  
      if (!token || type !== "recovery") {
        showError("Invalid or missing password reset link.");
        return;
      }
  
      // Verify the reset token and establish session
      try {
        const { data, error } = await supabase.auth.exchangeCodeForSession(token);
        
        if (error) {
          showError("Failed to verify reset link: " + error.message);
          return;
        }
        
        // Form submission handler
        document.getElementById("resetForm").addEventListener("submit", async (e) => {
          e.preventDefault();
          submitBtn.disabled = true;
          loadingIndicator.style.display = 'block';
          
          try {
            const newPassword = document.getElementById("new-password").value.trim();
            const confirmPassword = document.getElementById("confirm-password").value.trim();
  
            if (newPassword !== confirmPassword) {
              showError("Passwords do not match.");
              return;
            }
  
            const { error: updateError } = await supabase.auth.updateUser({
              password: newPassword
            });
  
            if (updateError) {
              showError("Failed to reset password: " + updateError.message);
              return;
            }
  
            alert("Password reset successfully! You can now login with your new password.");
            window.location.href = "index.html";
          } catch (err) {
            showError("An error occurred: " + err.message);
          } finally {
            submitBtn.disabled = false;
            loadingIndicator.style.display = 'none';
          }
        });
      } catch (err) {
        showError("An error occurred while verifying your link: " + err.message);
      }
    });
    
    function showError(message) {
      alert(message);
      console.error(message);
    }
  </script>  
</body>

</html>